# 附录：烧写自定义内核到SD卡

## 核心问题：如何在WSL2下将编译好的内核写入SD卡？

直接在WSL2中访问Windows物理设备是完全可行的，这也是最推荐的方法。你遇到的 `wsl --mount` 失败问题很可能是因为命令参数不正确或磁盘被Windows占用。

**正确流程如下：**

#### 步骤 1: 在 Windows 中识别 SD 卡

首先，将烧录好 Raspberry Pi OS 的 SD 卡通过读卡器连接到电脑。然后以 **管理员权限** 打开 PowerShell，运行以下命令：

```powershell

GET-CimInstance -query "SELECT * from Win32_DiskDrive"

```

根据 `Caption` 和 `Size` 找到你的SD卡。在你的例子中，SD卡是 `\\.\PHYSICALDRIVE1`。

#### 步骤 2: 在 WSL2 中挂载 SD 卡

1.  **卸载 Windows 挂载点**: 如果 SD 卡的任何分区（如 `boot` 或 `rootfs`）在 Windows 文件管理器中显示为盘符，请先安全弹出它们，以解除占用。

2.  **执行挂载命令**: 以 **管理员权限** 打开 PowerShell，运行 `wsl --mount` 命令。你需要挂载整个物理磁盘，而不是某个分区。
    ```powershell
    # 将 \\.\PHYSICALDRIVE1 替换为你的SD卡DeviceID
    wsl --mount \\.\PHYSICALDRIVE1 --bare
    ```
    这里的 `--bare` 参数意味着将整个设备附加到 WSL2，让我们可以直接操作其分区。

3.  **在 WSL2 中确认分区**: 打开 WSL2 终端，运行 `lsblk` 命令。你应该能看到一个新的设备（如 `/dev/sdb`），以及它的两个分区（如 `sdb1` for boot, `sdb2` for rootfs）。

#### 步骤 3: 部署编译产物

现在，你可以在 WSL2 中像操作普通 Linux 磁盘一样，将编译好的文件复制到 SD 卡的正确位置。

1.  **创建挂载点并挂载分区**:
    ```bash
    # 在你的 home 目录下创建挂载点
    mkdir -p ~/sdcard/boot ~/sdcard/rootfs

    # 挂载 boot 和 rootfs 分区 (将 sdb1 和 sdb2 替换为 lsblk 显示的实际分区名)
    sudo mount /dev/sdb1 ~/sdcard/boot
    sudo mount /dev/sdb2 ~/sdcard/rootfs
    ```

2.  **安装内核模块**:
    进入你的内核源码目录，使用 `INSTALL_MOD_PATH` 变量指向 rootfs 分区的挂载点来安装模块。
    ```bash
    cd ~/rpi-dev/linux  # 你的内核源码路径
    sudo make INSTALL_MOD_PATH=~/sdcard/rootfs modules_install
    ```

3.  **复制内核镜像和设备树文件**:
    ```bash
    # 备份旧内核
    sudo mv ~/sdcard/boot/kernel7.img ~/sdcard/boot/kernel7-backup.img

    # 复制新内核镜像
    sudo cp arch/arm/boot/zImage ~/sdcard/boot/kernel7.img

    # 复制设备树二进制文件
    sudo cp arch/arm/boot/dts/*.dtb ~/sdcard/boot/
    sudo cp arch/arm/boot/dts/overlays/*.dtbo ~/sdcard/boot/overlays/
    ```

4.  **复制 `config.txt` (如果需要)**
    通常，内核编译后也需要确保 `config.txt` 的配置与内核匹配。对于初次自定义内核，可以暂时使用原有的 `config.txt`。

#### 步骤 4: 卸载并验证

1.  **卸载分区**:
    ```bash
    sudo umount ~/sdcard/boot
    sudo umount ~/sdcard/rootfs
    ```

2.  **分离磁盘**: 回到 **管理员权限的 PowerShell**，执行 `unmount` 命令。
    ```powershell
    wsl --unmount \\.\PHYSICALDRIVE1
    ```

现在，你可以安全地拔出 SD 卡，插入 Raspberry Pi 3 并启动。通过 `uname -a` 命令检查内核版本和编译时间，确认内核已成功更新。

### 常见问题 (Troubleshooting)

*   **`wsl --mount` 失败**: 
    *   确保使用了管理员权限的 PowerShell。
    *   确保 SD 卡在 Windows 中已“弹出”，没有任何程序正在访问它。
    *   `指定的驱动器找不着` (0x8007000f) 错误通常意味着 `DeviceID` 错误或设备已被移除。重新运行 `GET-CimInstance` 确认。
*   **SD 卡为空可以吗？**
    不可以。SD卡必须先使用 **Raspberry Pi Imager** 烧写官方系统。这个过程不仅是复制文件，更重要的是创建了 `boot` 和 `rootfs` 两个分区，并安装了树莓派专用的引导加载程序 (bootloader)。我们的工作是替换这个系统中的内核，而不是从零创建一个系统。
