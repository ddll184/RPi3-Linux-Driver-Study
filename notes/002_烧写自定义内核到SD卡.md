# 第2节: 编译内核并烧写至SD卡

## 摘要

本节笔记详细记录了在 Linux 虚拟机 (VMware) 中为 Raspberry Pi 3 (BCM2837) 交叉编译 Linux 内核，并将编译产物（内核镜像、设备树、内核模块）部署到一张已经烧录了 Raspberry Pi OS 的 SD 卡上的完整流程。整个过程在纯 Linux 环境下完成，硬件访问更直接。

## 原理思维导图

```mermaid
graph TD
    subgraph 编译环境 (Linux VM on VMware)
        A[获取交叉编译器和内核源码] --> B{配置内核 (.config)};
        B --"make bcm2709_defconfig"--> C[执行交叉编译];
        C --"make -j$(nproc) zImage modules dtbs"--> D[生成内核产物];
    end

    subgraph 内核产物
        D --> E[zImage: 内核镜像];
        D --> F[*.ko: 内核模块];
        D --> G[*.dtb / *.dtbo: 设备树文件];
    end

    subgraph 部署到SD卡 (on Linux VM)
        H[准备已烧录OS的SD卡] --> I{连接SD卡读写器到VM};
        I --"VMware > Removable Devices"--> J[在VM中识别块设备];
        J --"lsblk"--> K[挂载boot和rootfs分区];
        K --"mount /dev/sdXn"--> L[拷贝产物到对应分区];
    end

    subgraph 产物与分区对应关系
        E --> L;
        F --> L;
        G --> L;
    end

    L --> M[安全卸载磁盘];
    M --"umount"--> N[树莓派上电, 启动新内核];

```

## 代码与命令精华

### 1. 关键环境变量与编译命令 (在 Linux VM 中)

```bash
# 设置目标架构和交叉编译工具链前缀
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

# RPi3 (32位) 使用 bcm2709 的配置
export KERNEL=kernel7
make bcm2709_defconfig

# 使用所有CPU核心进行编译
make -j$(nproc) zImage modules dtbs
```

### 2. 在 Linux 虚拟机中挂载 SD 卡

在 VMware 环境中，操作非常直接：

1.  **连接设备**: 将 SD 卡读写器插入电脑的 USB 口。在 VMware Player/Workstation 窗口的菜单栏找到你的设备（通常在 `虚拟机(VM) -> 可移动设备(Removable Devices)` 下），点击 "连接" (将其从主机断开)。

2.  **识别设备**: 在虚拟机的终端中，使用 `lsblk` 或 `fdisk -l` 命令来查看新连接的块设备。它通常会被识别为 `/dev/sdb` 或 `/dev/sdc`。

    ```bash
    $ lsblk
    NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
    sda           8:0    0   60G  0 disk 
    ├─sda1        8:1    0    1M  0 part 
    └─sda2        8:2    0   60G  0 part /
    sdb           8:16   1 29.7G  0 disk  # <--- 这是我们的SD卡
    ├─sdb1        8:17   1  256M  0 part  # <--- boot 分区
    └─sdb2        8:18   1 29.5G  0 part  # <--- rootfs 分区
    ```

3.  **挂载分区**: 根据 `lsblk` 的输出，挂载 boot 和 rootfs 分区。

    ```bash
    # 创建挂载点
    sudo mkdir -p /mnt/boot /mnt/rootfs

    # 挂载boot(FAT32)和rootfs(ext4)分区
    # 注意: sdb1/sdb2 需要根据 lsblk 的结果确认
    sudo mount /dev/sdb1 /mnt/boot
    sudo mount /dev/sdb2 /mnt/rootfs

    > **Note (根据我们的对话补充):**
    > 挂载后，可以使用 `lsblk` 命令检查分区情况。如果是初次烧录的官方镜像，`rootfs` 分区 (例如`/dev/sdb2`) 可能看起来比SD卡的总容量小很多（比如只有几GB）。这是正常现象。当这张SD卡在树莓派中首次启动时，系统会自动运行脚本将 `rootfs` 分区扩展以占满全部剩余空间。我们之前的操作已经验证了这一点。

    ```

### 3. 在 Linux VM 中部署文件

```bash
# 确认分区已挂载
df -h

# 部署内核模块到 rootfs
# INSTALL_MOD_PATH 指向 rootfs 的根目录
sudo make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- INSTALL_MOD_PATH=/mnt/rootfs modules_install

# 备份旧内核并复制新内核镜像
sudo mv /mnt/boot/kernel7.img /mnt/boot/kernel7-backup.img
sudo cp arch/arm/boot/zImage /mnt/boot/kernel7.img

# 复制设备树文件
sudo cp arch/arm/boot/dts/bcm2709-rpi-3-b.dtb /mnt/boot/

> **Attention (根据我们的对话补充):**
> 您的笔记记录的上述命令在执行时很可能会失败，这也是我们之前遇到的问题。原因是：
>
> 1.  **路径错误**: 在新版内核源码中，与特定主板相关的设备树文件 (`.dtb`) 不再直接放在 `dts` 目录下，而是根据芯片厂商被分类到了子目录中。对于树莓派，这个目录是 `arch/arm/boot/dts/broadcom/`。
> 2.  **文件名错误**: `bcm2709-rpi-3-b.dtb` 是一个不准确的名称。针对您使用的 BCM2837 芯片 (Raspberry Pi 3 Model B)，编译后生成的正确文件名是 `bcm2837-rpi-3-b.dtb`。
>
> **因此，正确的命令如下：**
> ```bash
> # [推荐] 做法一：拷贝所有适用于树莓派的 bcm2* 系列设备树文件
> # 这能提供最好的兼容性，而且新固件也可能在 overlays 目录里寻找 dtb 文件，所以两个位置都放一份更保险。
> sudo cp arch/arm/boot/dts/broadcom/bcm2*.dtb /mnt/boot/
> sudo cp arch/arm/boot/dts/broadcom/bcm2*.dtb /mnt/boot/overlays/
>
> # 做法二：只拷贝当前板型所需的最精确的文件
> sudo cp arch/arm/boot/dts/broadcom/bcm2837-rpi-3-b.dtb /mnt/boot/
> ```
>

sudo cp arch/arm/boot/dts/overlays/*.dtbo /mnt/boot/overlays/

> **Note (根据我们的对话补充): 为什么需要复制 `.dtbo` 文件?**
>
> 这条命令复制的是 **设备树浮层 (Device Tree Overlays)**。它们是用于描述**可选、可插拔**硬件模块（如传感器、显示屏、功能扩展板HAT等）的小块设备树片段。
>
> *   **主设备树 (`.dtb`)**: 描述树莓派主板本身的核心硬件。
> *   **设备树浮层 (`.dtbo`)**: 描述附加硬件。
>
> 将这些 `.dtbo` 文件复制到 SD 卡的 `overlays` 目录后，您就可以通过简单地编辑 `/boot/config.txt` 文件（例如添加 `dtoverlay=...`）来启用对应的硬件，而**无需为每个新硬件都重新编译整个内核**。这极大地增强了您自定义内核的灵活性和可扩展性。
```

### 4. 安全卸载 SD 卡

```bash
# 在终端中执行
sudo umount /mnt/boot /mnt/rootfs
```
卸载成功后，再在 VMware 菜单中将该 USB 设备与虚拟机 "断开连接"，之后便可安全拔出。

## 关联知识

- **交叉编译**: 在一个架构（如 x86_64）上编译出能在另一个架构（如 ARM）上运行的代码。这是嵌入式开发的基础。
- **设备树 (Device Tree)**: `*.dtb` 文件用于在启动时向内核描述硬件信息，实现了 Linux 内核与具体硬件的解耦。我们替换它，是为了确保内核能获取到最匹配硬件的描述。
- **内核模块 (`.ko`)**: 驱动程序等可以动态加载/卸载的功能单元。`modules_install` 命令会将它们安装到 `/lib/modules/$(uname -r)/` 目录下，这里的 `uname -r` 会变成我们新内核的版本号。

## 实战记录与故障排查 (Troubleshooting)

- **问题**: 在虚拟机中 `lsblk` 后看不到 SD 卡设备。
  - **原因**: USB 设备没有成功连接到虚拟机，可能仍被主机占用。
  - **解决方案**: 检查 VMware 窗口右下角的状态栏图标，或检查顶部菜单 `虚拟机 -> 可移动设备`，确保你的 "Generic USB Card Reader" (或类似名称) 前面有一个对勾，表示已连接到此虚拟机。如果未连接，请手动点击 "连接"。

- **问题**: `make bcm2837_defconfig` 失败, 提示 `Can't find default configuration`。
  - **原因**: 内核版本更新，部分 `defconfig` 文件名被整合或更改。根据 Raspberry Pi 官方文档，RPi3 (32位) 应使用 `bcm2709_defconfig`。
  - **解决方案**: 使用 `make bcm2709_defconfig`。

- **问题**: SD 卡是否需要预先烧录系统？
  - **回答**: 是的，必须先使用 Raspberry Pi Imager 等工具烧录一个官方的 Raspberry Pi OS 系统。我们的工作是“替换”这个系统中的内核，而不是从零制作一个系统。这个过程会创建好 `boot` (FAT32) 和 `rootfs` (ext4) 两个至关重要的分区，并包含启动引导程序。