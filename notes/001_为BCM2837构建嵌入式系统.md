# 第1章 学习环境搭建：为BCM2837构建嵌入式系统

## 摘要

本节核心在于搭建一个完整的、交叉编译的Linux内核开发环境，目标平台为Raspberry Pi 3 (BCM2837)。我们从准备源码、安装交叉编译器开始，最终目标是成功编译出可用于RPi3的Linux内核镜像 (`zImage`)、内核模块 (`.ko`) 和设备树二进制文件 (`.dtb`)。最后，我们将详细指导如何将编译产物安全地部署到SD卡，完成整个开发环境的闭环。

## 原理思维导图 (环境搭建流程)

1.  **准备工作 (Windows/WSL2)**
    *   安装WSL2 (推荐使用 Ubuntu)。
    *   安装基础编译依赖：`sudo apt update && sudo apt install build-essential git libncurses5-dev bison flex libssl-dev bc`。
    *   准备SD卡：使用 Raspberry Pi Imager 烧写最新的 Raspberry Pi OS Lite (32-bit) 镜像。这一步至关重要，因为它创建了正确的分区（boot和rootfs）和引导程序。

2.  **交叉编译环境配置 (WSL2)**
    *   下载并解压 ARM 交叉编译器。
        *   **注意**: 你提供的 `wget` 链接已失效 (404 Not Found)。建议从 [ARM开发者网站](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-a-and-gnu-eabi/downloads) 查找最新版本，或使用 `sudo apt install crossbuild-essential-armhf` 直接从apt仓库安装。
    *   将编译器路径添加到 `PATH` 环境变量。
    *   验证编译器：`arm-linux-gnueabihf-gcc -v`。

3.  **获取并配置内核源码 (WSL2)**
    *   `git clone --depth=1 https://github.com/raspberrypi/linux` 克隆官方内核源码。
    *   `cd linux` 进入源码目录。
    *   配置环境变量:
        ```bash
        export KERNEL=kernel7
        export ARCH=arm
        export CROSS_COMPILE=arm-linux-gnueabihf-
        ```
    *   生成RPi3的默认配置文件:
        ```bash
        # 错误尝试：make bcm2837_defconfig 会失败，因为没有这个配置
        # 正确配置 (RPi2/3 32-bit):
        make bcm2709_defconfig
        ```

4.  **编译内核 (WSL2)**
    *   执行编译命令，生成内核镜像、模块和设备树：
        ```bash
        make -j$(nproc) zImage modules dtbs
        ```

5.  **部署与验证 (SD Card & RPi3)**
    *   通过 `wsl --mount` 将SD卡挂载到WSL2环境。
    *   将编译产物部署到已烧录好系统的SD卡对应分区。
    *   将SD卡插入RPi3，启动系统，并通过 `uname -a` 验证新内核。

## 代码精华 (关键命令与配置)

### 1. 环境变量配置 (`~/.bashrc`)
为了避免每次打开终端都重新设置，建议将以下配置添加到 `~/.bashrc`：
```bash
# ARM 32-bit Cross-Compiler for Raspberry Pi (路径需根据实际情况修改)
# export PATH="$HOME/rpi-dev/tools/gcc-arm-10.3-2021.07-x86_64-arm-none-linux-gnueabihf/bin:$PATH"

# Raspberry Pi Kernel Build Environment
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
```
*注：请将 `PATH` 中的路径替换为你的实际编译器路径，如果使用apt安装则无需设置。*

### 2. 内核编译命令
```bash
# 1. 清理旧的编译产物 (可选)
# make mrproper

# 2. 生成 RPi3 (32-bit) 的默认配置
make bcm2709_defconfig

# 3. 开始全量编译 (利用所有CPU核心)
make -j$(nproc) zImage modules dtbs
```